<!--
 ~
 ~ This file is part of Hopsworks
 ~ Copyright (C) 2019, Logical Clocks AB. All rights reserved
 ~
 ~ Hopsworks is free software: you can redistribute it and/or modify it under the terms of
 ~ the GNU Affero General Public License as published by the Free Software Foundation,
 ~ either version 3 of the License, or (at your option) any later version.
 ~
 ~ Hopsworks is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 ~ without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
 ~ PURPOSE.  See the GNU Affero General Public License for more details.
 ~
 ~ You should have received a copy of the GNU Affero General Public License along with this program.
 ~ If not, see <https://www.gnu.org/licenses/>.
 ~
 -->
<p ng-show="sparkConfigCtrl.jobConfig.experimentType == 'EXPERIMENT'">A single process Python experiment.</p>
<p ng-show="sparkConfigCtrl.jobConfig.experimentType == 'PARALLEL_EXPERIMENTS'">Parallel Hyperparameter Optimization.</p>
<p ng-show="sparkConfigCtrl.jobConfig.experimentType == 'DISTRIBUTED_TRAINING'">Distributed Training using CollectiveAllReduceStrategy, ParameterServerStrategy and MirroredStrategy.</p>
<form class="form-horizontal">
    <div ng-include="'views/jupyter/commonConfig.html'"></div>
    <div class="form-group" ng-if="sparkConfigCtrl.jobConfig.experimentType == 'PARALLEL_EXPERIMENTS'">
        <label class="control-label col-sm-3" for="parallel-exp">Max parallel experiments: </label>
        <div class="col-sm-6">
            <input type="number" class="form-control" id="parallel-exp"  ng-init="1" min="1"
                   ng-model="sparkConfigCtrl.jobConfig['spark.dynamicAllocation.maxExecutors']">
        </div>
    </div>
    <div class="form-group" ng-if="sparkConfigCtrl.jobConfig.experimentType == 'DISTRIBUTED_TRAINING'">
        <label class="control-label col-sm-3" for="strategy">Distribution strategy: </label>
        <div class="col-sm-6">
            <select class="form-control" id="strategy" ng-model="sparkConfigCtrl.jobConfig.distributionStrategy">
                <option ng-repeat="strategy in sparkConfigCtrl.distribution_strategies" value="{{strategy.name}}">
                    {{strategy.displayName}}</option>
            </select>
        </div>
    </div>
    <div class="form-group" ng-if="sparkConfigCtrl.jobConfig.experimentType == 'DISTRIBUTED_TRAINING'">
        <label class="control-label col-sm-3" for="workers">Workers:</label>
        <div class="col-sm-6">
            <input type="number" class="form-control" id="workers"  ng-init="1" min="1"
                   ng-model="sparkConfigCtrl.jobConfig['spark.dynamicAllocation.maxExecutors']">
        </div>
    </div>
    <div class="form-group" ng-if="sparkConfigCtrl.jobConfig.experimentType == 'DISTRIBUTED_TRAINING' && sparkConfigCtrl.jobConfig.distributionStrategy === 'PARAMETER_SERVER'">
        <label class="control-label col-sm-3" for="ps">Parameter servers:</label>
        <div class="col-sm-6">
            <input type="number" class="form-control" id="ps"  min="0"
                   ng-model="sparkConfigCtrl.jobConfig['spark.tensorflow.num.ps']">
        </div>
    </div>
    <div ng-if="clusterUtilCtrl.allocatedGPUs !== 0 || clusterUtilCtrl.availableGPUs !== 0">
        <div class="form-group" ng-if="sparkConfigCtrl.jobConfig.experimentType === 'EXPERIMENT'">
            <label class="control-label col-sm-3" for="num-gpus">Number of GPUs: </label>
            <div class="col-sm-6">
                <input type="number" class="form-control" id="num-gpus" step="1" min="0"
                       ng-model="sparkConfigCtrl.jobConfig['spark.executor.gpus']">
            </div>
        </div>

        <div class="form-group" ng-if="sparkConfigCtrl.jobConfig.experimentType === 'PARALLEL_EXPERIMENTS'">
            <label class="control-label col-sm-3" for="num-gpus-per-exec">Number GPUs per Executor: </label>
            <div class="col-sm-6">
                <input type="number" class="form-control" id="num-gpus-per-exec" step="1" min="0"
                       ng-model="sparkConfigCtrl.jobConfig['spark.executor.gpus']">
            </div>
        </div>

        <div class="form-group" ng-if="sparkConfigCtrl.jobConfig.experimentType === 'DISTRIBUTED_TRAINING'">
            <label class="control-label col-sm-3" for="num-gpus-per-worker">Number GPUs per worker: </label>
            <div class="col-sm-6">
                <input type="number" class="form-control" id="num-gpus-per-worker" step="1" min="0"
                       ng-model="sparkConfigCtrl.jobConfig['spark.executor.gpus']">
            </div>
        </div>
        <div class="row" ng-if="sparkConfigCtrl.jobConfig['spark.executor.gpus'] > 1 && !(sparkConfigCtrl.sparkType === 'SPARK_STATIC' || sparkConfigCtrl.sparkType === 'SPARK_DYNAMIC')">
            <div class="col-md-2 jupyter-left"></div>
            <div class="col-md-9 pull-right" style="font-weight: bold; color: orange;">
                <i class="fa fa-warning" style="color:orange;"
                   uib-tooltip="Each Executor which runs the python code is allocated this number of GPUs.
                   Make sure your code can actually use the configured number, otherwise the unused GPUs should be
                   made available for other users."></i>
                <strong>&nbsp;Only set to greater than 1 if your wrapper function uses more than 1 GPU.</strong>
            </div>
        </div>
    </div>
    <h5 class="j-tab-advanced" ng-click="sparkConfigCtrl.advanced = !sparkConfigCtrl.advanced" data-toggle="collapse" data-target="#expAdvanced">
        Advanced configurations
        <i class="fa" ng-class="{'fa-chevron-down': sparkConfigCtrl.advanced, 'fa-chevron-right': !sparkConfigCtrl.advanced}" style="margin-left: 5px"></i>
    </h5>
    <div id="expAdvanced" ng-class="{'collapse in': sparkConfigCtrl.advanced, 'collapse': !sparkConfigCtrl.advanced}">
        <div ng-include="'views/jupyter/commonAdvancedConfig.html'"></div>
    </div>
</form>